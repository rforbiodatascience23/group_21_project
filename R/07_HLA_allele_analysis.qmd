---
title: "07_analysis_heatmap"
format: html
editor: visual
---

```{r}
#| message: false
library("tidyverse")
library("patchwork")
```

```{r, fig.height=20, fig.width=10}
#| warning: false
data <- read_tsv("./../data/04_aug_clean.tsv")

TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA'), GAD65) |>
  arrange(desc(desc(timepoint))) |> 
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)"))
  
#mutate(allele = paste(allele, subtype, sep = "*")) |>
#select(!subtype) |> 
#group_by(timepoint, allele) |> 
#mutate(allele_count = n(), .groups = NULL) |>
#filter(allele_count >= 3)


ggplot(data = TCR_tidy) +
  geom_tile(mapping = aes(x = allele,
                          y = subtype,
                          fill = GAD65)
            ) + 
  theme(axis.text.y = element_text(size = 4),
        axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient(low = "#3333FF",
                    high = "#FF3300")

```

```{r, fig.width=10}
#| warning: false
data <- read_tsv("./../data/04_aug_clean.tsv")

TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA')) |>
  arrange(desc(desc(timepoint))) |> 
  pivot_longer(starts_with('HLA'), 
               names_to = "allele",
               values_to = "subtype") |> 
  mutate(allele = paste(allele, subtype, sep = "*")) |>
  select(!subtype) |> 
  group_by(timepoint, allele) |> 
  mutate(allele_count = n(), .groups = NULL)
  
ggplot(data = TCR_tidy) +
  geom_tile(mapping = aes(x = timepoint,
                          y = allele_count),
            fill = TCR_tidy$timepoint
            ) + 
  scale_fill_gradient(low = "#FF9966",
                    high = "#FF3300")
  theme(axis.text.y = element_text(size = 4))
```

```{r, fig.height=8, fig.width=4}
#| warning: false
data <- read_tsv("./../data/04_aug_clean.tsv")

TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA'), GAD65, case_control) |>
  arrange(desc(desc(timepoint))) |> 
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
  group_by(allele, subtype) |> 
  mutate(allele_count = n(), .groups = NULL) |>
  filter(allele_count >= 5) |>
  filter(timepoint == 4) |>
  filter(subtype != "NA")


ggplot(data = TCR_tidy) +
  geom_tile(mapping = aes(x = allele,
                          y = subtype,
                          fill = log2(GAD65))
            ) + 
  theme_minimal()+
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(angle = 90, size = 10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_fill_gradient(low = "gray",
                    high = "#FF3300")

```
