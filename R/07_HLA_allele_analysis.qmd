---
title: "07_analysis_heatmap"
format: html
editor: visual
---

```{r}
#| include: false
library("tidyverse")
library("patchwork")
```

### Heatmap

```{r, fig.height=10, fig.width=8}
#| warning: false
data <- read_tsv("./../data/03_dat_aug.tsv",
                 show_col_types = FALSE)

HLA_tidy <- data |> 
  filter(timepoint == 4) |>
  select(starts_with("HLA"),
         case_control,
         id) |>
  pivot_longer(starts_with("HLA_"), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1) | (\\,2)")) |>
  mutate(allele_subtype = str_c(allele,
                                subtype,
                                sep=":")) |>
  na.omit(allele_subtype) |>
  mutate(subtype_n = 1) |>
  select(case_control,
         id,
         allele_subtype,
         subtype_n) |>
  group_by(case_control,allele_subtype) |>
  summarize(allele_n=n(),.groups="drop") |>
  pivot_wider(names_from=case_control,
              values_from=allele_n) |>
  na.omit(Control,Case) |>
  mutate(ratio = Case/Control)

```

```{r}
#| warning: false
data <- read_tsv("./../data/03_dat_aug.tsv")

TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA'), GAD65, case_control) |>
  arrange(desc(desc(timepoint))) |> 
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
  group_by(allele, subtype) |> 
  mutate(allele_count = n(), .groups = NULL) |>
  filter(allele_count >= 8) |>
  filter(timepoint == 4) |>
  filter(subtype != "NA") |>
  mutate(case_control = case_when(case_control == "Case" ~ 1,
                                  case_control == "Control" ~ 0))


ggplot(data = TCR_tidy) +
  geom_tile(mapping = aes(x = allele,
                          y = subtype,
                          fill = case_control)
            ) + 
  theme_bw()+
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(angle = 90, size = 10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_fill_viridis(option = "E")
```
