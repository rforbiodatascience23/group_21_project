---
title: "05_analysis_1.qmd"
format: html
editor: visual
---

```{r}
library("tidyverse")
library("broom")
```

```{r}
# converting case_control to representative numeric valus
conversion_table <- data.frame(
  case_control = c("Case","Control"),
  num_case_control = c(1, 0))

# loading the dataset and selecting the desired variables
data <- read_tsv("./../data/04_aug_clean.tsv")|>
  mutate(across(everything(), 
                ~replace_na(., 0))) |>
  select(case_control, GAD65, IA_2, IAA, ZnT8) |> # appending the conversion values
  left_join(conversion_table, by ="case_control") 

# principal component analysis
data_pca <- data |>
  select(-case_control)|>
  select(-num_case_control)|>
  scale() |> # normalizing the data 
  prcomp()

# plotting PC coordinates for individuals
data_pca |>
  augment(data) |># add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, 
             color = case_control)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c(Case = "#D55E00", 
               Control = "#0072B2")
  ) +
  theme_half_open(12) + 
  background_grid() +
    labs(title = "Plot of individuals",
         color = "Case vs Control")

# plotting scree plot for varialbe variation
data_pca |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#0072B2", 
           alpha = 0.8) + # making the bars slightly translusent 
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))) +
  geom_line(aes(PC),
            color = "red") +
  theme_minimal_hgrid(12) +
  background_grid() +

  labs(title = "Scree Plot",
       y = "percentage contribution")

# creating the aesthetics for the rotation matrix arrow
arrow_style <- arrow(length = unit(0.2, "cm"), 
                     ends = "first")

# appending num_case_control to the pca results
data_pca <- data_pca |>
  bind_cols(case_control = data$num_case_control)

# calculating the correlation between the num_case_control and pc's
num_case_control_coord <- as.data.frame(
  cor(data$num_case_control, data_pca$x)) |>
  mutate(Variable = "case_control")

# plotting the rotation matrix
data_pca |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value") |>
  ggplot(aes(x = PC2, y = PC1)) +
  geom_point(alpha = 0) +  # making the points fully transparent
  geom_segment(aes(xend = 0, yend = 0), arrow = arrow_style, color = "black") +
  coord_flip() +
  geom_text(aes(label = column), hjust = 1.2, nudge_x = -0.02, color = "#0072B2") +
  theme_half_open(12) + 
  background_grid() +
  labs(title = "Rotation Matrix") +
  geom_segment(
    data = num_case_control_coord,
    color = "red",
    xend = 0, yend = 0,
    arrow = arrow_style) +
  geom_text_repel(
    data = as.data.frame(num_case_control_coord),
    aes(label = Variable),
    color = "red")
```
