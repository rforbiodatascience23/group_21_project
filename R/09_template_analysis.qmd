---
title: "et_eller_andet"
format: html
editor: visual
---

## display data

```{r}
#| message: false
library("tidyverse")
library("viridis")
library("dplyr")
```

```{r}
#| warning: false
#| message: false
data <- read_tsv("./../data/03_dat_aug.tsv")

data |>
  group_by(case_control,age_visit,timepoint)|>
  summarize(total_temp_mu=log(mean(total_rearrangements))) |>
  ggplot(data=_,
         mapping=aes(x=age_visit,y=total_temp_mu))+
  geom_point(aes(color=timepoint))+
  labs(title="mean of total rearrangements vs. age at visit")+
  scale_color_viridis()+
  geom_smooth(method="lm",color="black")+
  facet_grid(vars(case_control))

data |>
  group_by(case_control,age_visit,timepoint)|>
  summarize(prod_temp_mu=log(mean(productive_rearrangements))) |>
  ggplot(data=_,
         mapping=aes(x=age_visit,y=prod_temp_mu))+
  geom_point(aes(color=timepoint))+
  labs(title="mean of productive rearrangements vs. age at visit")+
  scale_color_viridis()+
  geom_smooth(method="lm",color="black")+
  facet_grid(vars(case_control))


data |>
  group_by(case_control,age_visit,timepoint)|>
  summarize(frac_prod=mean(productive_rearrangements)/mean(total_rearrangements)) |>
  ggplot(data=_,
         mapping=aes(x=age_visit,y=frac_prod))+
  geom_point(aes(color=timepoint))+
  labs(title="fraction of productive rearrangements vs. age at visit")+
  scale_color_viridis()+
  geom_smooth(method="lm",color="black")+
  facet_grid(vars(case_control))
```

We see a slight rise in total and productive rearrangements for case patients and a decrease for control patients, when comparing the values against age at visit. So the number of rearrangements seems to be stable in case patients during aging, however there is decreasing rearrangement for the control patients.

We see a steep rise in the fraction of productive rearrangement with age, which must mean that the differences in values between productive rearrangement and total rearrangement become smaller with age.

```{r}
#simpson clonality plot

data |> 
  ggplot(data=_,
         mapping=aes(x=age_visit,y=log(productive_simpson_clonality)))+
  geom_point(aes(color=timepoint))+
  labs(title="mean of total rearrangements pr. timepoint")+
  scale_color_viridis()+
  geom_smooth(method="lm",color="black")+
  facet_grid(~case_control)

data|>
  filter(case_control=="Case")|>
  lm(productive_simpson_clonality~age_visit, data=_)

data|>
  filter(case_control=="Control")|>
  lm(productive_simpson_clonality~age_visit, data=_)
```

Both case and control show a direct proportionality between productive simpson clonality and age, which shows the decrease of polyclonality in the individuals.

```{r}

TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA'), GAD65, case_control,gender,age) |>
  arrange(desc(desc(timepoint))) |> 
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
  group_by(allele, subtype) |> 
  mutate(allele_count = n(), .groups = NULL) |>
  filter(subtype != "NA")


ggplot(data = TCR_tidy) +
  geom_tile(mapping = aes(x = allele,
                          y = subtype,
                          fill = allele_count)
            ) + 
  theme(axis.text.y = element_text(size = 4),
        axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient(low = "#3333FF",
                    high = "#FF3300")+
  facet_grid(~gender)
```

```{r}
data |>
  ggplot() +
  geom_histogram(aes(x = gender),stat="count",
               size = 0.5, fill = "darkred",
               bins = 15, color = "black") +
  labs(title = "Age of diagnosis, type 1 diabetes",
       subtitle = "Histogram",
       x = "Age of diagnosis")+
  facet_grid(~case_control)

data |>
  ggplot(data=_,
         mapping=aes(x=age_visit,y=IAA))+
  geom_point(aes(color=case_control))+
  facet_grid(~case_control)+
  scale_color_viridis(discrete=TRUE)

```

PCA Alleles

```{r}
HLA_tidy <- data |> 
  select(starts_with('HLA'), case_control,id,timepoint)  |>
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)"))|>
  na.omit(subtype)|>
  #mutate(subtype=str_replace_all(subtype,"NA",""))|>
  #group_by(case_control,id,timepoint,allele) |>
  #summarize(n_=n(),.group="drop")
  pivot_wider(names_from = allele,values_from = subtype, values_fn=list)
  #mutate(allele_count = n(), .groups = NULL)
  #filter(subtype != "NA") |>
  #pivot_wider(names_from = allele, values_from=allele_count)

```

```{r}
<<<<<<< HEAD
library("broom")
library("cowplot")

data <- read_tsv("./../data/03_dat_aug.tsv",na="N/A")
#biopsy <- read_csv("https://wilkelab.org/classes/SDS348/data_sets/biopsy.csv")

pca_data <- data|>
  select(case_control) |>
  select(where(is.numeric))|>
  scale()|>
  prcomp()

  
TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA'), GAD65, case_control) |>
  arrange(desc(desc(timepoint))) |> 
=======
HLA_tidy <- data |> 
  filter(timepoint==1)|>
  select(starts_with('HLA'), case_control,id)  |>
>>>>>>> 65f066cfce0bd17a18c6b61ed7f2d7b42db28b4f
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype")|>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
  mutate(allele_subtype=str_c(allele,subtype,sep=":"))|>
  na.omit(allele_subtype)|>
  mutate(subtype_n=1)|>
  select(case_control,id,allele_subtype,subtype_n)|>
  pivot_wider(names_from=allele_subtype,values_from=subtype_n)|>
  mutate(across(everything(), ~replace_na(.x, 0)))|>
  ungroup()
  

pca_fit <- HLA_tidy |> 
  select(starts_with("HLA")) |> # retain only numeric columns
  scale() |> # scale data
  prcomp() # do PCA


pca_fit |>
  augment(HLA_tidy) |> # add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, color = case_control)) + 
  geom_point(size = 1.5) +
  theme_half_open(12) + background_grid()

pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#0072B2", alpha = 0.8) +
  scale_x_continuous(breaks = 1:47) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  theme_bw() +
  labs(title = "Variance Explained by Each PC")
```
