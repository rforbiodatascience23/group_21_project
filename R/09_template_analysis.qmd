---
title: "et_eller_andet"
format: html
editor: visual
---

## Load libraries

```{r}
#| message: false
library("tidyverse")
library("viridis")
```

## Load Data

```{r}
#| message: false
data <- read_tsv("./../data/03_dat_aug.tsv")
```

## Analysis

### Total rearrangement

```{r}
#| message: false
data <- read_tsv("./../data/04_aug_clean.tsv")

data |>
  group_by(case_control,
           age_visit,
           timepoint)|>
  summarize(total_temp_mu = log( mean( total_rearrangements))) |>
  ggplot(data = _,
         mapping=aes(x = age_visit,
                     y = total_temp_mu))+
  geom_point(aes(color = timepoint))+
  labs(title = "Mean of Total Rearrangements vs. Age at visit",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "log( Total Rearrangement )",
       color = "Timepoint")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()
```

### Productive rearrangement

```{r}
#productive rearrangement
data |>
  group_by(case_control,
           age_visit,
           timepoint)|>
  summarize(prod_temp_mu = log( mean( productive_rearrangements))) |>
  ggplot(data = _,
         mapping = aes(x = age_visit,
                       y = prod_temp_mu))+
  geom_point(aes(color = timepoint))+
  labs(title = "Mean of Productive Rearrangements vs. Age at visit",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "log( Productive Rearrangement )",
       color = "Timepoint")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()
```

### Fraction productive rearrangement

```{r}
# fraction productive
data |>
  group_by(case_control,
           age_visit,
           timepoint)|>
  summarize(frac_prod = mean(productive_rearrangements) / mean(total_rearrangements)) |>
  ggplot(data = _,
         mapping = aes(x = age_visit,
                       y = frac_prod))+
  geom_point(aes(color = timepoint))+
  labs(title = "Fraction of Productive Rearrangements vs. Age at visit",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "Fraction of Productive Rearrangements",
       color = "Timepoint")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()
```

We see a slight rise in total and productive rearrangements for case patients and a decrease for control patients, when comparing the values against age at visit. So the number of rearrangements seems to be stable in case patients during aging, however there is decreasing rearrangement for the control patients.

We see a steep rise in the fraction of productive rearrangement with age, which must mean that the differences in values between productive rearrangement and total rearrangement become smaller with age.

### Productive Simpson Clonality

```{r}
#| message: false
#simpson clonality plot

data |> 
  ggplot(data = _,
         mapping = aes(x = age_visit,
                       y = log(productive_simpson_clonality)))+
  geom_point(aes(color = timepoint))+
  labs(title = "Productive Simpson Clonality vs. Age",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "log( Productive Simpson Clonality )")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()

```

Both case and control show a direct proportionality between productive simpson clonality and age, which shows the decrease of polyclonality in the individuals.

### PCA Alleles

```{r}
HLA_tidy <- data |> 
<<<<<<< HEAD
  filter(timepoint == 4)|>
  select(starts_with('HLA'),
         case_control,
         id)  |>
=======
  select(starts_with('HLA'), case_control,id,timepoint) |> 
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
  group_by(allele,case_control,id,timepoint) |> 
  mutate(allele_count = n(), .groups = NULL) |>
  filter(subtype != "NA") |>
  pivot_wider(names_from = allele, values_from=allele_count)
  
```

```{r}
library("broom")
library("cowplot")

data <- read_tsv("./../data/04_aug_clean.tsv",na="N/A")
#biopsy <- read_csv("https://wilkelab.org/classes/SDS348/data_sets/biopsy.csv")

pca_data <- data|>
  select(case_control, |>
  select(where(is.numeric))|>
  scale()|>
  prcomp()

  
TCR_tidy <- data |> 
  select(timepoint, age_visit,
         starts_with('HLA'), GAD65, case_control) |>
  arrange(desc(desc(timepoint))) |> 
>>>>>>> 760781579db27f00e1288d3855b65cd8f0dea6a8
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype") |>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
<<<<<<< HEAD
  mutate(allele_subtype = str_c(allele,
                                subtype,
                                sep=":"))|>
  na.omit(allele_subtype)|>
  mutate(subtype_n = 1)|>
  select(case_control,
         id,
         allele_subtype,
         subtype_n)|>
  pivot_wider(names_from = allele_subtype,
              values_from = subtype_n)|>
  mutate(across(everything(),
                ~replace_na(.x, 0)))|>
  ungroup()
  

pca_fit <- HLA_tidy |> 
  select(starts_with("HLA")) |> # retain only numeric columns
  scale()|>  # scale data
  prcomp() # do PCA


pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#482677", alpha = 0.8) +
  scale_x_continuous(breaks = 1:54) +
  scale_y_continuous(labels = scales::percent_format(),
                     expand = expansion(mult = c(0, 0.01))) +
  labs(title = "Variance Explained by Each PC")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90))
=======
  group_by(allele, subtype) |> 
  mutate(allele_count = n(), .groups = NULL) |>
  filter(subtype != "NA")

pca_data |>
  augment(pca_data) %>% # add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, color = outcome)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c(malignant = "#D55E00", benign = "#0072B2")
  ) +
  theme_half_open(12) + background_grid()

pca_fit <- data %>% 
  select(where(is.numeric)) %>% # retain only numeric columns
  scale() %>% # scale data
  prcomp() # do PCA



data <- read_tsv("./../data/04_aug_clean.tsv")|>
  mutate(across(everything(), 
                ~replace_na(., 0))) 

data_pca <- read_tsv("./../data/04_aug_clean.tsv")|>
  mutate(across(everything(), 
                ~replace_na(., 0))) |>
  select(case_control, starts_with("HLA")) |>
  select(where(is.numeric)) |> # retain only numeric columns
  scale() |> # normalizing the data 
  prcomp()


# plotting PC coordinates for individuals
data_pca |>
  augment(data) |># add original dataset back in
  ggplot(aes(.fittedPC1, .fittedPC2, 
             color = case_control)) + 
  geom_point(size = 1.5) +
  scale_color_viridis(discrete=TRUE)+
  theme_half_open(12) + 
  background_grid() +
    labs(title = "Plot of individuals",
         color = "Case vs Control")

# plotting scree plot for varialbe variation
data_pca |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#0072B2", 
           alpha = 0.8) + # making the bars slightly translusent 
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))) +
  geom_line(aes(PC),
            color = "red") +
  theme_minimal_hgrid(12) +
  background_grid() +

  labs(title = "Scree Plot",
       y = "percentage contribution")

# plotting the rotation matrix
arrow_style <- arrow(length = unit(0.2, "cm"), 
                     ends = "first")

data_pca |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value") |>
  ggplot(aes(x = PC2, y = PC1)) +
  geom_point(alpha = 0) +  # making the points fully transparent
  geom_segment(aes(xend = 0, yend = 0), 
               arrow = arrow_style, 
               color = "black") +
  coord_flip() +
  geom_text(aes(label = column), hjust = 1.2, nudge_x = -0.02, color = "#0072B2") +
  theme_half_open(12) + 
  background_grid() +
  labs(title = "Rotation Matrix")
>>>>>>> 760781579db27f00e1288d3855b65cd8f0dea6a8
```

None of the variables describe the variance in data, therefore no indication of allele subtype can conclude difference between case or control.
