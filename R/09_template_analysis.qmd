---
title: "et_eller_andet"
format: html
editor: visual
---

## Load libraries

```{r}
#| message: false
library("tidyverse")
library("viridis")
library("dplyr")
```

## Load Data

```{r}
#| message: false
data <- read_tsv("./../data/03_dat_aug.tsv")
```

## Analysis

### Total rearrangement

```{r}
#| message: false

data |>
  group_by(case_control,
           age_visit,
           timepoint)|>
  summarize(total_temp_mu = log( mean( total_rearrangements))) |>
  ggplot(data = _,
         mapping=aes(x = age_visit,
                     y = total_temp_mu))+
  geom_point(aes(color = timepoint))+
  labs(title = "Mean of Total Rearrangements vs. Age at visit",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "log( Total Rearrangement )",
       color = "Timepoint")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()
```

### Productive rearrangement

```{r}
#productive rearrangement
data |>
  group_by(case_control,
           age_visit,
           timepoint)|>
  summarize(prod_temp_mu = log( mean( productive_rearrangements))) |>
  ggplot(data = _,
         mapping = aes(x = age_visit,
                       y = prod_temp_mu))+
  geom_point(aes(color = timepoint))+
  labs(title = "Mean of Productive Rearrangements vs. Age at visit",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "log( Productive Rearrangement )",
       color = "Timepoint")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()
```

### Fraction productive rearrangement

```{r}
# fraction productive
data |>
  group_by(case_control,
           age_visit,
           timepoint)|>
  summarize(frac_prod = mean(productive_rearrangements) / mean(total_rearrangements)) |>
  ggplot(data = _,
         mapping = aes(x = age_visit,
                       y = frac_prod))+
  geom_point(aes(color = timepoint))+
  labs(title = "Fraction of Productive Rearrangements vs. Age at visit",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "Fraction of Productive Rearrangements",
       color = "Timepoint")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()
```

We see a slight rise in total and productive rearrangements for case patients and a decrease for control patients, when comparing the values against age at visit. So the number of rearrangements seems to be stable in case patients during aging, however there is decreasing rearrangement for the control patients.

We see a steep rise in the fraction of productive rearrangement with age, which must mean that the differences in values between productive rearrangement and total rearrangement become smaller with age.

### Productive Simpson Clonality

```{r}
#| message: false
#simpson clonality plot

data |> 
  ggplot(data = _,
         mapping = aes(x = age_visit,
                       y = log(productive_simpson_clonality)))+
  geom_point(aes(color = timepoint))+
  labs(title = "Productive Simpson Clonality vs. Age",
       subtitle = "Faceted by outcome and stratified by timepoint",
       x = "Age",
       y = "log( Productive Simpson Clonality )")+
  scale_color_viridis()+
  geom_smooth(method = "lm",
              color = "black")+
  facet_grid(vars(case_control))+
  theme_bw()

```

Both case and control show a direct proportionality between productive simpson clonality and age, which shows the decrease of polyclonality in the individuals.

### PCA Alleles

```{r}
HLA_tidy <- data |> 
  filter(timepoint == 4)|>
  select(starts_with('HLA'),
         case_control,
         id)  |>
  pivot_longer(starts_with('HLA_'), 
               names_to = "allele",
               values_to = "subtype")|>
  mutate(allele = str_remove(allele, "(\\,1)|(\\,2)")) |>
  mutate(allele_subtype = str_c(allele,
                                subtype,
                                sep=":"))|>
  na.omit(allele_subtype)|>
  mutate(subtype_n = 1)|>
  select(case_control,
         id,
         allele_subtype,
         subtype_n)|>
  pivot_wider(names_from = allele_subtype,
              values_from = subtype_n)|>
  mutate(across(everything(),
                ~replace_na(.x, 0)))|>
  ungroup()
  

pca_fit <- HLA_tidy |> 
  select(starts_with("HLA")) |> # retain only numeric columns
  scale()|>  # scale data
  prcomp() # do PCA


pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#482677", alpha = 0.8) +
  scale_x_continuous(breaks = 1:54) +
  scale_y_continuous(labels = scales::percent_format(),
                     expand = expansion(mult = c(0, 0.01))) +
  labs(title = "Variance Explained by Each PC")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90))
```

None of the variables describe the variance in data, therefore no indication of allele subtype can conclude difference between case or control.
